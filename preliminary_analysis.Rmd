---
title: "preliminary analysis"
output: html_document
date: "2025-02-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
```

## prepare datasets
```{r}
combined_tract_data <- read.csv("/Users/huangjiaxin/Desktop/JHU/7th term/combined_tract_data.csv", header = TRUE)

# gender
combined_tract_data1 <- combined_tract_data %>%
  mutate(
    # Education variables
    high_school_pct = High_School_Graduate / Total_Education_Population * 100,
    bachelors_pct = Bachelors_Degree / Total_Education_Population * 100,
    graduate_pct = Graduate_Professional_Degree / Total_Education_Population * 100,
    
    # Employment variables
    unemployment_rate = Total_Unemployed / (Total_Employed + Total_Unemployed) * 100,
    
    # Transportation variables
    drove_alone_pct = Drove_Alone_to_Work / Total_Commuters * 100,
    public_transit_pct = Public_Transportation_Users / Total_Commuters * 100,
    worked_from_home_pct = Worked_From_Home / Total_Commuters * 100
  ) 

# for plotting, use pct
data <- combined_tract_data1[, c(8:10, 27:33, 42, 45:51)]

# Create a color palette where Baltimore City is highlighted
data <- data %>%
  mutate(is_baltimore = grepl("Baltimore city", NAME),
         county = ifelse(is_baltimore, "Baltimore City", sub("Census Tract .*?; (.*?);.*", "\\1", NAME))) %>%
  filter(county != "NA")

county_colors <- ifelse(unique(data$county) == "Baltimore City", "pink2", "grey60")
names(county_colors) <- unique(data$county)
```

## data visualization
data from 2022 general election, age, gender and race are for registered voters only, rest are from census data
```{r}
# Gender
ggplot(data, aes(x = county, y = Male_Pct, fill = is_baltimore)) +
  geom_boxplot() +
  labs(title = "Gender Distribution by County",
       x = "County",
       y = "Registered Male Population (%)") +
  scale_fill_manual(values = c("FALSE" = "grey60", "TRUE" = "pink2")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  guides(fill = FALSE)

# Race
race_long <- data %>%
  select(county, is_baltimore, White_Pct, Hispanic_Pct, Black_Pct, Asian_Pct, Other_Race_Pct) %>%
  pivot_longer(cols = c(White_Pct, Hispanic_Pct, Black_Pct, Asian_Pct, Other_Race_Pct),
               names_to = "race",
               values_to = "percentage") %>%
  mutate(race = factor(race,
                       levels = c("White_Pct", "Hispanic_Pct", "Black_Pct", "Asian_Pct", "Other_Race_Pct"),
                       labels = c("White", "Hispanic", "Black", "Asian", "Other")))

ggplot(race_long, aes(x = county, y = percentage, fill = is_baltimore)) +
  geom_boxplot() +
  facet_wrap(~ race, scales = "free_y") +
  labs(title = "Race by County",
       x = "",
       y = "Percentage of Population") +
  scale_fill_manual(values = c("FALSE" = "grey60", "TRUE" = "pink2"),
                    labels = c("FALSE" = "Other Counties", "TRUE" = "Baltimore City"),
                    name = "Location") +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        strip.background = element_rect(fill = "lightblue", color = "black"),
        strip.text = element_text(face = "bold"),
        legend.position = "none")

# Income Distribution
ggplot(data, aes(x = county, y = edian_Household_Income, fill = is_baltimore)) +
  geom_boxplot() +
  labs(title = "Median Household Income by County",
       x = "County",
       y = "Median Household Income ($)") +
  scale_fill_manual(values = c("FALSE" = "grey60", "TRUE" = "pink2")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  guides(fill = FALSE)

# Employment Status
ggplot(data, aes(x = county, y = unemployment_rate, fill = is_baltimore)) +
  geom_boxplot() +
  labs(title = "Unemployment Rate by County",
       x = "County",
       y = "Unemployment Rate (%)") +
  scale_fill_manual(values = c("FALSE" = "grey60", "TRUE" = "pink2")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  guides(fill = FALSE)

## outlier: census tract 1402

# education
edu_long <- data %>%
  select(county, is_baltimore, high_school_pct, bachelors_pct, graduate_pct) %>%
  pivot_longer(cols = c(high_school_pct, bachelors_pct, graduate_pct),
               names_to = "education_level",
               values_to = "percentage") %>%
  mutate(education_level = factor(education_level, 
                                 levels = c("high_school_pct", "bachelors_pct", "graduate_pct"),
                                 labels = c("High School", "Bachelor's Degree", "Graduate Degree")))

ggplot(edu_long, aes(x = county, y = percentage, fill = is_baltimore)) +
  geom_boxplot() +
  facet_wrap(~ education_level, scales = "free_y") +
  labs(title = "Education Levels by County",
       x = "",
       y = "Percentage of Population") +
  scale_fill_manual(values = c("FALSE" = "grey60", "TRUE" = "pink2"),
                    labels = c("FALSE" = "Other Counties", "TRUE" = "Baltimore City"),
                    name = "Location") +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        strip.background = element_rect(fill = "lightblue", color = "black"),
        strip.text = element_text(face = "bold"),
        legend.position = "none")

# transportation
transport_long <- data %>%
  select(county, is_baltimore, drove_alone_pct, public_transit_pct, worked_from_home_pct) %>%
  pivot_longer(cols = c(drove_alone_pct, public_transit_pct, worked_from_home_pct),
               names_to = "transport_mode",
               values_to = "percentage") %>%
  mutate(transport_mode = factor(transport_mode, 
                                levels = c("drove_alone_pct", "public_transit_pct", "worked_from_home_pct"),
                                labels = c("Drove Alone", "Public Transit", "Worked From Home")))

ggplot(transport_long, aes(x = county, y = percentage, fill = is_baltimore)) +
  geom_boxplot() +
  facet_wrap(~ transport_mode, scales = "free_y") +
  labs(title = "Transportation Methods by County",
       x = "",
       y = "Percentage of Commuters") +
  scale_fill_manual(values = c("FALSE" = "grey60", "TRUE" = "pink2"),
                    labels = c("FALSE" = "Other Counties", "TRUE" = "Baltimore City"),
                    name = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.background = element_rect(fill = "lightblue", color = "black"),
        strip.text = element_text(face = "bold"),
        legend.position = "none")
```


## summary statistics
```{r}
data_table <- data_table %>%
  mutate(is_baltimore = grepl("Baltimore city", NAME),
         county = ifelse(is_baltimore, "Baltimore City", sub("Census Tract .*?; (.*?);.*", "\\1", NAME))) %>%
  filter(county != "NA")

state_avg <- data_table %>%
  summarize(
    # Calculate counts and totals separately
    male_count = sum(Male_Count, na.rm = TRUE),
    total_reg = sum(Total_reg, na.rm = TRUE),
    male_pct = (male_count / total_reg) * 100,

    white_count = sum(White_Count, na.rm = TRUE),
    white_pct = (white_count / total_reg) * 100,

    hispanic_count = sum(Hispanic_Count, na.rm = TRUE),
    hispanic_pct = (hispanic_count / total_reg) * 100,

    black_count = sum(Black_Count, na.rm = TRUE),
    black_pct = (black_count / total_reg) * 100,

    asian_count = sum(Asian_Count, na.rm = TRUE),
    asian_pct = (asian_count / total_reg) * 100,

    # Education levels
    high_school_grad = sum(High_School_Graduate, na.rm = TRUE),
    total_edu_pop = sum(Total_Education_Population, na.rm = TRUE),
    high_school_pct = (high_school_grad / total_edu_pop) * 100,

    bachelors_degree = sum(Bachelors_Degree, na.rm = TRUE),
    bachelors_pct = (bachelors_degree / total_edu_pop) * 100,

    graduate_degree = sum(Graduate_Professional_Degree, na.rm = TRUE),
    graduate_pct = (graduate_degree / total_edu_pop) * 100,

    # Unemployment rate
    total_unemployed = sum(Total_Unemployed, na.rm = TRUE),
    total_employed = sum(Total_Employed, na.rm = TRUE),
    unemployment_rate = (total_unemployed / (total_employed + total_unemployed)) * 100,

    # Commuting methods
    drove_alone = sum(Drove_Alone_to_Work, na.rm = TRUE),
    total_commuters = sum(Total_Commuters, na.rm = TRUE),
    drove_alone_pct = (drove_alone / total_commuters) * 100,

    public_transit_users = sum(Public_Transportation_Users, na.rm = TRUE),
    public_transit_pct = (public_transit_users / total_commuters) * 100,

    worked_from_home = sum(Worked_From_Home, na.rm = TRUE),
    worked_from_home_pct = (worked_from_home / total_commuters) * 100,

    # Median income
    median_income = median(edian_Household_Income, na.rm = TRUE)
  )


bal_city <- data_table %>%
  filter(grepl("Baltimore city", NAME)) %>%
  summarize(
    # Calculate counts and totals separately
    male_count = sum(Male_Count, na.rm = TRUE),
    total_reg = sum(Total_reg, na.rm = TRUE),
    male_pct = (male_count / total_reg) * 100,

    white_count = sum(White_Count, na.rm = TRUE),
    white_pct = (white_count / total_reg) * 100,

    hispanic_count = sum(Hispanic_Count, na.rm = TRUE),
    hispanic_pct = (hispanic_count / total_reg) * 100,

    black_count = sum(Black_Count, na.rm = TRUE),
    black_pct = (black_count / total_reg) * 100,

    asian_count = sum(Asian_Count, na.rm = TRUE),
    asian_pct = (asian_count / total_reg) * 100,

    # Education levels
    high_school_grad = sum(High_School_Graduate, na.rm = TRUE),
    total_edu_pop = sum(Total_Education_Population, na.rm = TRUE),
    high_school_pct = (high_school_grad / total_edu_pop) * 100,

    bachelors_degree = sum(Bachelors_Degree, na.rm = TRUE),
    bachelors_pct = (bachelors_degree / total_edu_pop) * 100,

    graduate_degree = sum(Graduate_Professional_Degree, na.rm = TRUE),
    graduate_pct = (graduate_degree / total_edu_pop) * 100,

    # Unemployment rate
    total_unemployed = sum(Total_Unemployed, na.rm = TRUE),
    total_employed = sum(Total_Employed, na.rm = TRUE),
    unemployment_rate = (total_unemployed / (total_employed + total_unemployed)) * 100,

    # Commuting methods
    drove_alone = sum(Drove_Alone_to_Work, na.rm = TRUE),
    total_commuters = sum(Total_Commuters, na.rm = TRUE),
    drove_alone_pct = (drove_alone / total_commuters) * 100,

    public_transit_users = sum(Public_Transportation_Users, na.rm = TRUE),
    public_transit_pct = (public_transit_users / total_commuters) * 100,

    worked_from_home = sum(Worked_From_Home, na.rm = TRUE),
    worked_from_home_pct = (worked_from_home / total_commuters) * 100,

    # Median income
    median_income = median(edian_Household_Income, na.rm = TRUE)
  )


compare1 <- rbind(state_avg, bal_city)
```



